#!/bin/bash

#set -x

OCAML_TY_DIR=/usr/local/stow/ocaml-ty-2006-06-22/bin
OCAMLC=$OCAML_TY_DIR/ocamlc.opt
OCAMLOPT=$OCAML_TY_DIR/ocamlopt.opt

# first try if cmi are available at all
file ../elsa/*cmi 2>&1 >/dev/null

if [ $? = 0 ] ; then
    version=$(file ../elsa/*cmi | head -1 | \
	sed -e ' s/.*file (\([^)]*\)) (Version \([0-9]*\).*/\1-\2/')
else
    version=""
fi

#echo version = $version

if [ ${version:=".cmi-010"} = ".cmi-010" ] ; then
    (cd ../elsa; rm -f *cmi *cmo *cmx)
    (cd ../ast; rm -f *cmi *cmo *cmx)
    rm -f *cmi *cmo *cmx

    make -C ../ast OCAMLC=$OCAMLC OCAMLOPT=$OCAMLOPT ast_ml_objects
    make -C ../elsa OCAMLC=$OCAMLC OCAMLOPT=$OCAMLOPT elsa_ml_objects
fi


make OCAMLC=$OCAMLC OCAMLOPT=$OCAMLOPT OCAMLCC=$OCAMLOPT check-oast

