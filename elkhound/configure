#!/bin/sh
# setup a parsgen dist to build on linux

# ----------- functions -----------
usage() {
  echo "usage: $0 --ocaml"
  echo "  OR"
  echo "       $0 --nocaml"
  echo "  depending on whether you are Wes or Scott.  :)"
  exit
}

# generate the parsgen Makefile
setupMakefile() {
  mf=Makefile
  echo "creating $mf ..."

  echo "# Makefile for parsgen" > $mf || exit
  echo "# NOTE: generated by ./configure -- editing inadvisable" >> $mf
  echo "" >> $mf

  if [ "$ocaml" = "yes" ]; then
    # just strip the leading tags
    sed 's/^OCAMLINCL //' < $mf.in >> $mf
  else
    # remove lines containing the tags
    grep -v '^OCAMLINCL ' < $mf.in >> $mf
  fi
}


# -------- main -----------
if [ "$1" = "--ocaml" ]; then
  ocaml="yes"
elif [ "$1" = "--nocaml" ]; then
  ocaml="no"
else
  usage
fi

# hack so I can run just one function
if [ "$2" = "--setupMakefile" ]; then
  setupMakefile
  exit
fi


# -------- setup plat --------
# assume linux
cd plat || exit
echo "making symlink in plat ..."
ln -s Makefile.linux Makefile. || exit
cd ..


# --------- setup smbase ----------
# fill in correct PLAT line in smbase Makefile
echo "rewriting smbase/Makefile.base.mk ..."
apply 'sed s,PLAT\ =.\*,PLAT\ =\ '`pwd`/plat, smbase/Makefile.base.mk || exit


# ---------- setup parsgen ----------
cd parsgen || exit

# generate Makefile
setupMakefile

# make the symlink in parsgen to smbase
echo "making symlink in parsgen ...."
ln -s ../smbase . || exit

cd ..
