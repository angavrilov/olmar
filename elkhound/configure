#!/bin/sh
# setup a parsgen dist to build on linux

# ----------- functions -----------
usage() {
  echo "usage: $0 --ocaml"
  echo "  OR"
  echo "       $0 --nocaml"
  echo "  depending on whether you want Ocaml stuff or not"
  echo ""
  echo "another possible usage is"
  echo "  $0 (--ocaml|--nocaml) --setupMakefile"
  echo "which will simply rengerate Makefile from Makefile.in"
  echo ""
  exit
}

# generate the parsgen Makefile
setupMakefile() {
  mf=Makefile
  echo "creating $mf ..."

  # overcome my chmod below
  rm -f $mf

  echo "# Makefile for parsgen" > $mf || exit
  echo "# NOTE: generated by ./configure -- editing inadvisable" >> $mf
  echo "" >> $mf

  if [ "$ocaml" = "yes" ]; then
    # just strip the leading OCAML tags, and remove NOCAML lines
    cat $mf.in | sed 's/^OCAMLINCL//' | grep -v '^NOCAMLINCL' >> $mf
  else
    # strip NOCAML, remove OCAML lines
    cat $mf.in | sed 's/^NOCAMLINCL//' | grep -v '^OCAMLINCL' >> $mf
  fi

  # discourage editing ..
  chmod a-w $mf
}


# -------- main -----------
if [ "$1" = "--ocaml" ]; then
  ocaml="yes"
elif [ "$1" = "--nocaml" ]; then
  ocaml="no"
else
  usage
fi

# hack so I can run just one function
if [ "$2" = "--setupMakefile" ]; then
  setupMakefile
  exit
fi


# -------- setup plat --------
# assume linux
cd plat || exit
echo "making symlink in plat ..."
ln -s Makefile.linux Makefile. || exit
cd ..


# --------- setup smbase ----------
# fill in correct PLAT line in smbase Makefile
mf=smbase/Makefile.base.mk
echo "making $mf ..."
sed 's,PLAT =.*,PLAT = '`pwd`/plat, < $mf.in > $mf || exit


# ---------- setup parsgen ----------
cd parsgen || exit

# generate Makefile
setupMakefile

# make the symlink in parsgen to smbase
echo "making symlink in parsgen ...."
ln -s ../smbase . || exit

cd ..


# ---------- setup ml_cil ---------------
if [ "$ocaml" = "yes" ]; then
  cd ml_cil || exit
  
  echo "ml_cil: making symlink to ../parsgen/cc.bin ..."
  ln -s ../parsgen/cc.bin . || exit

  echo "ml_cil: creating obj/ and obj/.depend/ ..."
  mkdir obj || exit
  mkdir obj/.depend || exit
fi
