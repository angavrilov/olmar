# Makefile.in
# this is the Makefile for Elsa, the Elkhound-based C++ Parser

# main target: a C++ parser
all: ccparse

# directories of other software
SMBASE   := @SMBASE@
AST      := @AST@
ELKHOUND := @ELKHOUND@

# stuff inside those other directories
LIBSMBASE   := $(SMBASE)/libsmbase.a
LIBAST      := $(AST)/libast.a
LIBELKHOUND := $(ELKHOUND)/libelkhound.a


# re-create the Makefile if Makefile.in has changed
Makefile: Makefile.in
	./config.status


# ----------------------- compiler configuration -------------------
# C++ preprocessor, compiler and linker
CXX := g++

# flags for the C++ compiler (and preprocessor)
CCFLAGS := @CCFLAGS@ -I$(SMBASE) -I$(AST) -I$(ELKHOUND)

# flags for the linker
libraries := $(LIBELKHOUND) $(LIBAST) $(LIBSMBASE)
LDFLAGS := -g -Wall $(libraries)


# compile .cc in this directory to a .o
%.o: %.cc
	$(CXX) -c -o $@ $< $(CCFLAGS)
	@$(SMBASE)/depend.pl -o $@ $< $(CCFLAGS) >$*.d


# ----------------------- lexer2 -------------------
# run flex on the lexer description
lexer1yy.cc: lexer1.lex lexer1.h
	flex lexer1.lex


# modules needed for lexer2 stand-alone
LEXER2_OBJS := \
  lexer1.o \
  lexer1yy.o \
  cc_lang.o

# lexer2 stand-alone binary
lexer2: lexer2.cc lexer2.h $(LEXER2_OBJS)
	$(CXX) -o $@ -DTEST_LEXER2 $(CCFLAGS) lexer2.cc $(LEXER2_OBJS) $(LDFLAGS)


# ------------------------- ccparse ---------------------
# run lexer2 stand-alone to generate token list
cc.tok: lexer2
	./lexer2 -myparser >$@

# run astgen to generate the AST implementation
CC_AST_MODS := cc.ast cc_tcheck.ast cc_print.ast
cc.ast.gen.h cc.ast.gen.cc: $(CC_AST_MODS) $(AST)/astgen
	$(AST)/astgen -occ.ast.gen $(CC_AST_MODS)


# run elkhound to generate the parser
cc.gr.gen.h cc.gr.gen.cc: cc.gr cc.tok $(ELKHOUND)/elkhound
	$(ELKHOUND)/elkhound -v -o cc.gr.gen cc.gr


# list of modules needed for the parser
CCPARSE_OBJS := \
  cc.ast.gen.o \
  cc.gr.gen.o \
  cc_lang.o \
  lexer1.o \
  lexer1yy.o \
  lexer2.o \
  parssppt.o \
  cc_env.o \
  cc_scope.o \
  cc_flags.o \
  cc_type.o \
  cc_tcheck.o \
  cc_print.o \
  cc_ast_aux.o \
  treeout.o \
  variable.o \
  ccparse.o \
  main.o

# parser binary
ccparse: $(CCPARSE_OBJS)
	$(CXX) -o $@ $(CCPARSE_OBJS) $(LDFLAGS)


# ---------------------- misc ---------------------
# rule to decompress one of the big examples
in/big/%.i: in/big/gz/%.i.gz
	gunzip -c <$^ >$@

# decompress all of them which haven't already been decompressed
.PHONY: in/big
in/big: $(patsubst in/big/gz/%.i.gz,in/big/%.i,$(wildcard in/big/gz/*.gz))
	@echo made $@


# -------------------- clean, etc. -------------------
clean:
	rm -f *.o *.d *.gen.* *.tab.* *.output a.out core
	rm -f lexer1yy.cc cc.tok
	rm -f outdir/*
	rm -f lexer2 ccparse

distclean: clean
	rm -f Makefile config.status config.summary
	rm -f in/big/*.i

check: all
	./regrtest
	@echo ""
	@echo "Regression tests passed."
