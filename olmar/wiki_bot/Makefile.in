# Makefile for olmar/wiki_bot
#
#  Copyright 2006-2007 Hendrik Tews, All rights reserved. #
#  See file license.txt for terms of use                  #
###########################################################

# other directories
UTIL:= ../util
GENERAL:=  ../build/general
ASTGEN_OR:= ../build/astgen
META=../meta

# external tools
OCFIND=ocamlfind

OC_OBJ_EXT := @OC_OBJ_EXT@
OC_LIB_EXT := @OC_LIB_EXT@
OC_NATIVE:=@OC_NATIVE@

OC_COMP_FLAGS := -w Ae -package netclient
OC_INC_FLAGS := -I $(UTIL) -I $(GENERAL) -I $(ASTGEN_OR) -I $(META)
OC_FLAGS := $(OC_COMP_FLAGS) $(OC_INC_FLAGS)
OC_BYTE_FLAGS := -g
ifeq ($(OC_NATIVE),1)
  OCDEPOPTS := -native
  OCFMOD := ocamlopt
else
  OCDEPOPTS :=
  OCFMOD := ocamlc
endif

OCDEBUG=0
ifeq ($(OCDEBUG),1)
  OCOPT := $(OCC) -g
  OCCC  := $(OCC) -g
  OCC   := $(OCC) -g
  OC_OBJ_EXT := cmo
  OC_LIB_EXT := cma
  OCDEPOPTS :=
  OCFMOD := ocamlc
endif

OC :=$(OCFIND) $(OCFMOD)

all: stage_2

stage_1:

stage_2: wiki_bot

stage_3:

stage2: stage_2

# list of files to clean in 'clean' (etc.) targets
# (these get added to below)
TOCLEAN :=
TODISTCLEAN :=


#############################################################################
#####
##### wiki_bot

WIKI_ML := \
	$(UTIL)/olmar_utils.$(OC_LIB_EXT) \
	$(GENERAL)/astgen_general.$(OC_LIB_EXT) \
	$(ASTGEN_OR)/astgen_lib.$(OC_LIB_EXT) \
	$(META)/meta_ast_lib.$(OC_LIB_EXT) \
	netstring_ext.ml \
	form_values.ml \
	wiki_http.ml \
	wiki_bot.ml

TOCLEAN += wiki_bot
wiki_bot: $(WIKI_ML:.ml=.$(OC_OBJ_EXT))
	$(OC) -linkpkg $(OC_FLAGS) -o $@ $^

# ./wiki_bot -tr ../build/elsa/elsa_reflection_control.txt ../build/elsa/elsa.ast.oast -summary


############################################################################
#### Misc
#### 

.PHONY: clean
clean:
	rm -f $(TOCLEAN)


.PHONY: distclean
distclean: clean
	rm -f Makefile config.status config.summary
	rm -f astmapfuns.mli


TOCLEAN += *.cmo *.cmxa *.cma *.a
%.cmo: %.ml
	$(OC) $(OC_BYTE_FLAGS) $(OC_FLAGS) -c $<

TOCLEAN += *.cmx *.o
%.cmx: %.ml
	$(OC) $(OC_FLAGS) -c $<

TOCLEAN += *.cmi
%.cmi: %.mli
	$(OC) $(OC_FLAGS) -c $<


-include mldeps.mk

.PHONY: mldeps
depend: mldeps
mldeps:
	ocamldep $(OC_INC_FLAGS) $(OCDEPOPTS) *ml *mli > mldeps.mk

# re-create Makefile if Makefile.in has changed
TODISTCLEAN += Makefile
Makefile: Makefile.in ../config.status
	(cd ..; ./config.status -only wiki_bot)

