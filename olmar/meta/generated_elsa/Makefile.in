# Makefile for olmar/meta/generated_elsa
#
#  Copyright 2006-2007 Hendrik Tews, All rights reserved. #
#  See file license.txt for terms of use                  #
###########################################################


# other directories
UTIL:= ../../util
GENERAL:=  ../../build/general
ELSA_OR:= ../../build/elsa

ELSA_REFL_CONTROL := $(ELSA_OR)/elsa_reflection_control.txt

# configure section
OCC := @OCC@
OCCC := @OCCC@
OCOPT := @OCOPT@
OC_OBJ_EXT := @OC_OBJ_EXT@
OC_LIB_EXT := @OC_LIB_EXT@
OC_NATIVE := @OC_NATIVE@
OCDIR := @OCDIR@

OC_COMP_FLAGS := -w Ae
OC_INC_FLAGS := -I $(UTIL) -I $(GENERAL) -I $(ELSA_OR) -I ..
OC_FLAGS := $(OC_COMP_FLAGS) $(OC_INC_FLAGS)
OC_BYTE_FLAGS := -g
ifeq ($(OC_NATIVE),1)
  OCDEPOPTS := -native
else
  OCDEPOPTS :=
endif

OCDEBUG=0
ifeq ($(OCDEBUG),1)
  OCOPT := $(OCC) -g
  OCCC  := $(OCC) -g
  OCC   := $(OCC) -g
  OC_OBJ_EXT := cmo
  OC_LIB_EXT := cma
  OCDEPOPTS :=
endif

.PHONY: all
all: 	elsa_ast_util.$(OC_LIB_EXT) ast_graph


# list of files to clean in 'clean' (etc.) targets
# (these get added to below)
TOCLEAN =
TODISTCLEAN =

# # re-create the Makefile if Makefile.in has changed
# TODISTCLEAN += Makefile
# Makefile: Makefile.in config.status
# 	./config.status

# # reconfigure if the configure script has changed
# config.status: configure.pl $(SMBASE)/sm_config.pm
# 	./config.status -reconfigure


############################################################################
#### accessors
#### 

TOCLEAN += ast_accessors_generated.ml
ast_accessors_generated.ml: \
		../gen_accessors $(ELSA_OR)/elsa.ast.oast $(ELSA_REFL_CONTROL)
	../gen_accessors $(ELSA_OR)/elsa.ast.oast \
		-tr $(ELSA_REFL_CONTROL) \
		-o ast_accessors_generated \
		-expr-type-accessor

TOCLEAN += ast_accessors.ml
ast_accessors.ml: ast_accessors_header.ml ast_accessors_generated.ml \
		ast_accessors_trailer.ml
	echo "# 1 \"`pwd`/ast_accessors_header.ml\"" > $@
	cat ast_accessors_header.ml >> $@
	echo "# 1 \"`pwd`/ast_accessors_generated.ml\"" >> $@
	cat ast_accessors_generated.ml >> $@
	echo "# 1 \"`pwd`/ast_accessors_trailer.ml\"" >> $@
	cat ast_accessors_trailer.ml >> $@


ast_accessors.cmo: $(ELSA_OR)/elsa_reflect_type.cmo
ast_accessors.cmx: $(ELSA_OR)/elsa_reflect_type.cmx

############################################################################
#### superast
#### 

TOCLEAN += superast_generated.ml superast_generated.mli
superast_generated.ml superast_generated.mli: \
		../gen_superast $(ELSA_OR)/elsa.ast.oast $(ELSA_REFL_CONTROL)
	../gen_superast $(ELSA_OR)/elsa.ast.oast \
		-tr $(ELSA_REFL_CONTROL) \
		-o superast_generated

TOCLEAN += superast.mli
superast.mli: superast_header.mli superast_generated.mli superast_trailer.mli
	echo "# 1 \"`pwd`/superast_header.mli\"" > $@
	cat superast_header.mli >> $@
	echo "# 1 \"`pwd`/superast_generated.mli\"" >> $@
	cat superast_generated.mli >> $@
	echo "# 1 \"`pwd`/superast_trailer.mli\"" >> $@
	cat superast_trailer.mli >> $@

TOCLEAN += superast.ml
superast.ml: superast_header.ml superast_generated.ml superast_trailer.ml
	echo "# 1 \"`pwd`/superast_header.ml\"" > $@
	cat superast_header.ml >> $@
	echo "# 1 \"`pwd`/superast_generated.ml\"" >> $@
	cat superast_generated.ml >> $@
	echo "# 1 \"`pwd`/superast_trailer.ml\"" >> $@
	cat superast_trailer.ml >> $@


superast.cmi: ast_accessors.$(OC_OBJ_EXT)
superast.cmx: superast.cmi
superast.cmo: superast.cmi


############################################################################
#### uplinks
#### 

TOCLEAN += uplinks_generated.ml
uplinks_generated.ml: ../gen_uplinks $(ELSA_OR)/elsa.ast.oast \
		$(ELSA_REFL_CONTROL)
	../gen_uplinks $(ELSA_OR)/elsa.ast.oast \
		-tr $(ELSA_REFL_CONTROL) \
		-o uplinks_generated

TOCLEAN += uplinks.ml
uplinks.ml: uplinks_header.ml uplinks_generated.ml \
		uplinks_trailer.ml
	echo "# 1 \"`pwd`/uplinks_header.ml\"" > $@
	cat uplinks_header.ml >> $@
	echo "# 1 \"`pwd`/uplinks_generated.ml\"" >> $@
	cat uplinks_generated.ml >> $@
	echo "# 1 \"`pwd`/uplinks_trailer.ml\"" >> $@
	cat uplinks_trailer.ml >> $@

uplinks.cmx: uplinks.cmi superast.cmx
uplinks.cmo: uplinks.cmi superast.cmi
uplinks.cmi: superast.cmi $(GENERAL)/ast_annotation.cmi


############################################################################
#### elsa_ast_utils
#### 

ELSA_AST_UTIL_ML= \
	ast_accessors.ml \
	superast.ml \
	uplinks.ml

elsa_ast_util.cma: $(ELSA_AST_UTIL_ML:.ml=.cmo)
	$(OCC) -a -o $@ $^

elsa_ast_util.cmxa: $(ELSA_AST_UTIL_ML:.ml=.cmx)
	$(OCOPT) -a -o $@ $^






############################################################################
#### ast_graph
#### 

TOCLEAN += ast_graph_generated.ml
ast_graph_generated.ml: ../gen_graph $(ELSA_REFL_CONTROL) \
		$(ELSA_OR)/elsa.ast.oast
	../gen_graph $(ELSA_OR)/elsa.ast.oast \
		-tr $(ELSA_REFL_CONTROL) \
		-o ast_graph_generated

TOCLEAN += ast_graph.ml
ast_graph.ml: ast_graph_header.ml ast_graph_generated.ml \
		ast_graph_trailer.ml
	echo "# 1 \"`pwd`/ast_graph_header.ml\"" > $@
	cat ast_graph_header.ml >> $@
	echo "# 1 \"`pwd`/ast_graph_generated.ml\"" >> $@
	cat ast_graph_generated.ml >> $@
	echo "# 1 \"`pwd`/ast_graph_trailer.ml\"" >> $@
	cat ast_graph_trailer.ml >> $@

ast_graph.cmx: uplinks.cmx
ast_graph.cmo: uplinks.cmo

AST_GRAPH_ML=\
	$(UTIL)/olmar_utils.$(OC_LIB_EXT) \
	$(GENERAL)/astgen_general.$(OC_LIB_EXT) \
	$(ELSA_OR)/elsa_lib.$(OC_LIB_EXT) \
	elsa_ast_util.$(OC_LIB_EXT) \
	ast_graph.ml


TOCLEAN += ast_graph
ast_graph: $(AST_GRAPH_ML:.ml=.$(OC_OBJ_EXT))
	$(OCCC) $(OC_COMP_FLAGS) -o $@ $^


############################################################################
#### Misc
#### 

.PHONY: clean
clean:
	rm -f $(TOCLEAN)

.PHONY: distclean
distclean: clean
	rm -f Makefile config.status config.summary
	rm -f astmapfuns.mli


TOCLEAN += *.cmo *.cmxa *.cma *.a
%.cmo: %.ml
	$(OCC) $(OC_BYTE_FLAGS) $(OC_FLAGS) -c $<

TOCLEAN += *.cmx *.o
%.cmx: %.ml
	$(OCOPT) $(OC_FLAGS) -c $<

TOCLEAN += *.cmi
%.cmi: %.mli
	$(OCC) $(OC_FLAGS) -c $<


-include mldeps.mk

.PHONY: mldeps
depend: mldeps
mldeps:
	ocamldep $(OCDEPOPTS) $(OC_INC_FLAGS) *ml *mli > mldeps.mk


# re-create Makefile if Makefile.in has changed
TODISTCLEAN += Makefile
Makefile: Makefile.in ../../config.status
	(cd ../..; ./config.status -only meta/generated_elsa)

